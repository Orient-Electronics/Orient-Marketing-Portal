<div class="box box-color box-bordered">
  <div class="box-title">
    <h3>
      <i class="icon-map-marker"></i>
      Locations Information
    </h3>
    <div class="actions">
      <a href="#" class="btn btn-mini content-remove"><i class="icon-remove"></i></a>
      <a href="#" class="btn btn-mini content-slideUp"><i class="icon-angle-down"></i></a>
    </div>
  </div>
  <div class="box-content no-padding">
    <div class="span12" id="map_location" style="height: 500px;">
    </div>
    <textarea class="hide" id="lat"><%= @shops.collect(&:location).collect(&:latitude).join("|") %></textarea>
    <textarea class="hide" id="lng"><%= @shops.collect(&:location).collect(&:longitude).join("|") %></textarea>
    <textarea class="hide" id="shop_category"><%= @shops.collect(&:shop_category).collect(&:name).join("|")%></textarea>
  </div>
</div>

<%= content_for :footer_js do %>
<script type="text/javascript" charset="utf-8">
  var map;
  var markersArray = [];
  var lat_arr;
  var lng_arr;
  var category_arr; 

  function initialize(lat,lng){
    pos = (lat + ",") + lng;
    var mapOptions = {
      'center': (new google.maps.LatLng(lat,lng)),
      zoom: 4,
      'disableDefaultUI':true,
      'mapTypeControl': true,
      'panControl': true,
      'zoomControl': true
    };
    map = new google.maps.Map($("#map_location")[0], mapOptions);

    for (var i=0;i<lat_arr.length;i++)
    { 
      var lat = convert(lat_arr[i]);
      var lng = convert(lng_arr[i]);
      var category = category_arr[i];
      if(lat &&  lng)
        addMarker((new google.maps.LatLng(lat,lng)), map, category);
    }
  }

  function setgeolocation(address){
    geocoder = new google.maps.Geocoder();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK)
      {
          lat = results[0].geometry.location.lat();
          lng = results[0].geometry.location.lng();
          initialize(lat,lng)
      }
    });
  }

  function addMarker(location,mapp,shop_category) {
    switch(shop_category)
    {
      case "Sony World" || "Sony Center":
        marker_icon = '/assets/icon/sony.png';
        break;
      case "Dawlance USL" :
        marker_icon ='/assets/icon/dawlance-usl.png';
        break;
      case "Orient Exclusive" :
        marker_icon = '/assets/icon/orient.png';
        break;  
      case "Orient Center" :
        marker_icon = '/assets/icon/orient-center.png';
        break;
      case "Dawlance Exclusive" :
        marker_icon = '/assets/icon/dawlance.png';
        break;
      case "Haier Exclusive" :
        marker_icon = '/assets/icon/haier.png';
        break;
      case "LG Concept Shop" :
        marker_icon = '/assets/icon/lg.png';
        break;
      case "PEL Exclusive" :
        marker_icon = '/assets/icon/pel.png';
        break; 
      case "Ruba Digital" :
        marker_icon = '/assets/icon/ruba-digital.png';
        break; 
      case "Samsung Concept Shop" || "Samsung Brand Shop":
        marker_icon = '/assets/icon/samsung.png';
        break;
      case "Singer Plus" :
        marker_icon = '/assets/icon/singer.png';
        break;                 
      default:
        marker_icon ='';
      break;  
    } 
    marker = new google.maps.Marker({
      position: location,
      map: mapp,
      icon: marker_icon
    });
    marker.addListener("dragend", function(marker, ev) {
      point = marker.latLng;
    });
    markersArray.push(marker);
  }

  function deleteOverlays() {
    if (markersArray) {
      for (i in markersArray) {
        markersArray[i].setMap(null);
      }
      markersArray.length = 0;
    }
  }

  function isNumber(o) {
    return !isNaN(o - 0);
  }

  function convert(c) {
      if (isNumber(c))
          return Number(c);

      var match = false;
      var points = {
          sign: 1,
          degree: 0,
          min: 0,
          sec: 0
      };

      var MinDec = /^([NWES+-])*(\d+)°(\d+).(\d+)'/i; // 067°08.601', -067°08.601', E067°08.601'
      var DMS = /^([NWES+-])*(\d+)°(\d+)'(\d+)\.?(\d+)*"/i; // 33°36'47", -33°36'47", N33°36'47"

      if (c.match(MinDec)) {
          var arr = MinDec.exec(c);

          match = true;
          points.sign = (arr[1] == 'W' || arr[1] == 'S' || arr[1] == '-') ? -1 : 1;
          points.degree = Number(arr[2]);
          points.min = Number(arr[3] + '.' + arr[4]);
      }
      else if (c.match(DMS)) {
          var arr = DMS.exec(c);

          match = true;
          points.sign = (arr[1] == 'W' || arr[1] == 'S' || arr[1] == '-') ? -1 : 1;
          points.degree = Number(arr[2]);
          points.min = Number(arr[3]);
          points.sec = Number(arr[4] + '.' + arr[5]);
      }

      if (match) {
          return (points.degree + ((points.min * 60 + points.sec) / 3600)) * points.sign;
      }

      return false;
  }

  $('document').ready(function () {
    lat_arr = $("#lat").val().split("|");
    lng_arr = $("#lng").val().split("|");
    category_arr = $("#shop_category").val().split("|");
    setgeolocation("Pakistan");
  });
</script>
<% end -%>